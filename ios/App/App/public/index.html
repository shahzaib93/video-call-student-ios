<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob: capacitor:; script-src * 'unsafe-inline' 'unsafe-eval'; style-src * 'unsafe-inline';" />
    <title>Tarteel-e-Quran - Student Portal</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
  <style>
    #root {
      min-height: 100vh;
      background-color: #f5f5f5;
    }
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #667eea;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: white;
      font-family: 'Inter', sans-serif;
      z-index: 9999;
    }
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loading-text {
      margin-top: 20px;
      font-size: 18px;
    }
  </style>
    <script type="module" src="./assets/index-5dbd37d8.js"></script>
    <link rel="modulepreload" href="./assets/vendor-2ef7cb16.js">
    <link rel="modulepreload" href="./assets/material-f11f11dc.js">
    <link rel="modulepreload" href="./assets/firebase-ddd95b06.js">
  </head>
  <body>
    <div id="root">
      <div class="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="status">Testing iOS... Step 1</div>
      </div>
    </div>
    <!-- WebRTC Support -->
    <script>
      // AGGRESSIVE ERROR DISPLAY FOR iOS
      function updateStatus(msg) {
        var el = document.getElementById('status');
        if (el) {
          el.innerHTML = msg;
          console.log(msg);
        }
      }

      updateStatus('Step 2: HTML loaded ‚úì');

      setTimeout(function() { updateStatus('Step 3: JavaScript running ‚úì'); }, 100);

      console.log('üîß Student: Initializing WebRTC polyfills...');
      
      // Crypto.randomUUID polyfill for older browsers
      if (!crypto.randomUUID) {
        crypto.randomUUID = function() {
          return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0;
            var v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
          });
        };
      }
      
      // Ensure WebRTC API compatibility
      window.RTCPeerConnection = window.RTCPeerConnection || window.webkitRTCPeerConnection || window.mozRTCPeerConnection;
      
      // Legacy getUserMedia fallback (deprecated but needed for older browsers)
      navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
      
      // Enhanced MediaDevices API polyfill
      if (!navigator.mediaDevices) {
        console.log('üì± Student: Creating mediaDevices polyfill...');
        navigator.mediaDevices = {};
      }
      
      if (!navigator.mediaDevices.getUserMedia) {
        console.log('üé• Student: Creating getUserMedia polyfill...');
        navigator.mediaDevices.getUserMedia = function(constraints) {
          console.log('üé• Student: Polyfill getUserMedia called with:', constraints);
          
          // First try the modern API
          var getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
          
          if (!getUserMedia) {
            console.error('‚ùå Student: No getUserMedia implementation found');
            return Promise.reject(new Error('WebRTC getUserMedia is not supported in this browser. Please use Chrome, Firefox, or Safari.'));
          }
          
          console.log('‚úÖ Student: Using legacy getUserMedia');
          return new Promise(function(resolve, reject) {
            try {
              getUserMedia.call(navigator, constraints, function(stream) {
                console.log('‚úÖ Student: getUserMedia success via polyfill');
                resolve(stream);
              }, function(error) {
                console.error('‚ùå Student: getUserMedia error via polyfill:', error);
                reject(error);
              });
            } catch (error) {
              console.error('‚ùå Student: Exception in getUserMedia polyfill:', error);
              reject(error);
            }
          });
        };
      } else {
        console.log('‚úÖ Student: Native getUserMedia available');
      }
      
      // Test mediaDevices availability
      if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        console.log('‚úÖ Student: mediaDevices.getUserMedia is available');
      } else {
        console.error('‚ùå Student: mediaDevices.getUserMedia is still not available after polyfill');
      }
      
      // Check for HTTPS requirement for web apps
      if (location.protocol !== 'https:' && 
          location.hostname !== 'localhost' && 
          location.hostname !== '127.0.0.1') {
        console.warn('‚ö†Ô∏è  WebRTC requires HTTPS for camera/microphone access (except on localhost)');
      }
      
      console.log('‚úÖ Student: WebRTC polyfills initialized');
      updateStatus('Step 4: WebRTC polyfills ready ‚úì');

      // Debug: Check if we're in Capacitor
      console.log('üì± Platform:', navigator.platform);
      console.log('üì± User Agent:', navigator.userAgent);
      console.log('üì± Is iOS:', /iPad|iPhone|iPod/.test(navigator.userAgent));
      updateStatus('Step 5: Platform detected: ' + navigator.platform);

      setTimeout(function() {
        updateStatus('Step 6: Waiting for React...');
      }, 500);

      // Show a visible message if scripts fail to load
      setTimeout(function() {
        var root = document.getElementById('root');
        if (root && root.children.length === 1 && root.children[0].className === 'loading-screen') {
          console.error('‚ùå App failed to load after 10 seconds');
          updateStatus('‚ùå React FAILED to load!<br><small>URL: ' + window.location.href + '</small>');
        }
      }, 10000);
    </script>
    
  </body>
</html>