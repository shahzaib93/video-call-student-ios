name: Build iOS App

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-ios:
    name: Build iOS Application
    runs-on: macos-latest

    env:
      IOS_APP_DIR: ios/App
      ARCHIVE_PATH: ios/App/build/App.xcarchive
      EXPORT_PATH: ios/App/build/export
      APP_SCHEME: App

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build web assets
        run: npm run build

      - name: Verify build output
        run: |
          echo "üì¶ Checking dist folder contents:"
          ls -lh dist/
          echo ""
          echo "üìÑ Checking dist/assets folder:"
          ls -lh dist/assets/ | head -20
          echo ""
          echo "üìÑ Checking dist/index.html:"
          cat dist/index.html
          echo ""
          echo "üîç Checking if bundles are empty:"
          for file in dist/assets/*.js; do
            size=$(wc -c < "$file")
            echo "$file: $size bytes"
            if [ $size -lt 1000 ]; then
              echo "‚ùå WARNING: File is suspiciously small!"
              cat "$file"
            fi
          done
          echo ""
          echo "‚úÖ Build verification complete"

      - name: Recreate iOS with proper permissions
        run: |
          echo "üóëÔ∏è Removing old broken iOS project..."
          rm -rf ios
          echo "‚úÖ Removed"

          echo "üÜï Creating FRESH iOS project with Capacitor 7..."
          npx cap add ios
          echo "‚úÖ Fresh iOS created"

          echo "üì¶ Syncing web assets to iOS..."
          npx cap sync ios
          echo "‚úÖ Assets synced"

          echo "üìã Verifying capacitor.config.json was copied to iOS:"
          cat ios/App/App/capacitor.config.json
          echo ""
          echo "üìÑ Verifying index.html was copied to iOS:"
          ls -la ios/App/App/public/
          echo ""
          echo "üìÑ Checking if index.html exists and has content:"
          if [ -f "ios/App/App/public/index.html" ]; then
            echo "‚úÖ index.html EXISTS"
            wc -l ios/App/App/public/index.html
            head -30 ios/App/App/public/index.html
          else
            echo "‚ùå ERROR: index.html DOES NOT EXIST!"
            exit 1
          fi
          echo ""
          echo "‚úÖ Capacitor sync complete"
          echo ""
          echo "‚ÑπÔ∏è  NOTE: iOS folder is NOT committed (gets recreated every build)"

      - name: Verify iOS project structure
        run: |
          echo "üìã Checking iOS project structure..."
          ls -la ios/App/App/
          echo ""
          echo "üìÑ Checking public folder:"
          ls -la ios/App/App/public/
          echo ""
          echo "üìÑ First 50 lines of index.html:"
          head -50 ios/App/App/public/index.html

      - name: Install CocoaPods dependencies
        run: |
          cd "$IOS_APP_DIR"
          pod install

      - name: Save App Store Connect API key
        env:
          ASC_KEY_ID: ${{ secrets.APPLE_ASC_KEY_ID }}
          ASC_PRIVATE_KEY: ${{ secrets.APPLE_ASC_PRIVATE_KEY }}
        run: |
          mkdir -p ~/private_keys
          printf "%s" "$ASC_PRIVATE_KEY" > ~/private_keys/AuthKey_${ASC_KEY_ID}.p8
          chmod 600 ~/private_keys/AuthKey_${ASC_KEY_ID}.p8

      - name: Import signing certificate
        env:
          APPLE_P12: ${{ secrets.APPLE_P12_NEW }}
          APPLE_P12_PASSWORD: ${{ secrets.APPLE_P12_PASSWORD_NEW }}
        run: |
          KEYCHAIN_PASSWORD=ios-build
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain-db"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          echo "$APPLE_P12" | base64 --decode > signing.p12
          security import signing.p12 -k "$KEYCHAIN_PATH" -P "$APPLE_P12_PASSWORD" -T /usr/bin/codesign
          rm signing.p12

          security list-keychains -d user -s "$KEYCHAIN_PATH"
          security default-keychain -s "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

      - name: Build iOS archive (automatic signing)
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          ASC_KEY_ID: ${{ secrets.APPLE_ASC_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APPLE_ASC_KEY_ISSUER_ID }}
        run: |
          cd "$IOS_APP_DIR"

          # List available certificates
          echo "üìã Available signing identities:"
          security find-identity -v -p codesigning

          xcodebuild \
            -workspace App.xcworkspace \
            -scheme "$APP_SCHEME" \
            -configuration Release \
            -sdk iphoneos \
            -archivePath "$ARCHIVE_PATH" \
            -allowProvisioningUpdates \
            -authenticationKeyPath ~/private_keys/AuthKey_${ASC_KEY_ID}.p8 \
            -authenticationKeyID "$ASC_KEY_ID" \
            -authenticationKeyIssuerID "$ASC_ISSUER_ID" \
            DEVELOPMENT_TEAM="$APPLE_TEAM_ID" \
            MARKETING_VERSION="1.0.0" \
            CURRENT_PROJECT_VERSION="1" \
            archive

      - name: Export signed IPA
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          ASC_KEY_ID: ${{ secrets.APPLE_ASC_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APPLE_ASC_KEY_ISSUER_ID }}
        run: |
          cd "$IOS_APP_DIR"
          python3 - <<'PY'
          import os, plistlib

          data = {
              'method': 'ad-hoc',
              'signingStyle': 'automatic',
              'teamID': os.environ['APPLE_TEAM_ID'],
              'stripSwiftSymbols': True,
              'compileBitcode': False,
          }

          with open('exportOptions.plist', 'wb') as fh:
              plistlib.dump(data, fh)
          PY

          echo "üìã Export options created:"
          cat exportOptions.plist
          echo "üöÄ Starting export..."
          xcodebuild \
            -exportArchive \
            -archivePath "$ARCHIVE_PATH" \
            -exportOptionsPlist exportOptions.plist \
            -exportPath "$EXPORT_PATH" \
            -allowProvisioningUpdates \
            -authenticationKeyPath ~/private_keys/AuthKey_${ASC_KEY_ID}.p8 \
            -authenticationKeyID "$ASC_KEY_ID" \
            -authenticationKeyIssuerID "$ASC_ISSUER_ID" || {
              echo "‚ùå Export failed, checking what was created:"
              ls -la "$EXPORT_PATH" || echo "Export path doesn't exist"
              exit 1
            }

          echo "‚úÖ Export completed, checking output:"
          ls -la "$EXPORT_PATH"
          find "$EXPORT_PATH" -name "*.ipa" -o -name "*.app"

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-app-development
          path: ios/App/build/export/*.ipa
          retention-days: 30

      - name: Verify .ipa was created and contains assets
        run: |
          echo "üîç Verifying .ipa file..."
          IPA_FILE=$(find ios/App/build/export -name "*.ipa" | head -1)
          if [ -z "$IPA_FILE" ]; then
            echo "‚ùå No .ipa file found!"
            exit 1
          fi
          echo "‚úÖ Found .ipa: $IPA_FILE"
          echo "üì¶ Size: $(du -h "$IPA_FILE" | cut -f1)"

          echo "üîç Checking .ipa contents..."
          unzip -l "$IPA_FILE" | grep -E "index.html|\.js$" | head -20

      - name: Build Summary
        run: |
          echo "‚úÖ iOS App build successful" >> $GITHUB_STEP_SUMMARY
          echo "üì¶ Artifact: ios-app-development (.ipa)" >> $GITHUB_STEP_SUMMARY
          echo "üîê Signing: Automatic provisioning" >> $GITHUB_STEP_SUMMARY
