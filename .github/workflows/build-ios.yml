name: Build iOS App

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-ios:
    name: Build iOS Application
    runs-on: macos-latest

    env:
      IOS_APP_DIR: ios/App
      ARCHIVE_PATH: ios/App/build/App.xcarchive
      EXPORT_PATH: ios/App/build/export
      APP_SCHEME: App

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Build web assets
        run: npm run build

      - name: Sync Capacitor
        run: npx cap sync ios

      - name: Install CocoaPods dependencies
        run: |
          cd "$IOS_APP_DIR"
          pod install

      - name: Setup App Store Connect API Key
        env:
          ASC_KEY_ID: ${{ secrets.APPLE_ASC_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APPLE_ASC_KEY_ISSUER_ID }}
          ASC_PRIVATE_KEY: ${{ secrets.APPLE_ASC_PRIVATE_KEY }}
        run: |
          mkdir -p ~/private_keys
          echo "$ASC_PRIVATE_KEY" > ~/private_keys/AuthKey_${ASC_KEY_ID}.p8
          chmod 600 ~/private_keys/AuthKey_${ASC_KEY_ID}.p8

          # Verify key format
          if ! head -1 ~/private_keys/AuthKey_${ASC_KEY_ID}.p8 | grep -q "BEGIN PRIVATE KEY"; then
            echo "‚ùå Invalid API key format. Should start with -----BEGIN PRIVATE KEY-----"
            exit 1
          fi
          echo "‚úÖ API key format verified"

      - name: Disable Push Notifications Capability
        run: |
          cd "$IOS_APP_DIR"
          # Remove push notification entitlements if file exists
          if [ -f "App/App.entitlements" ]; then
            echo "Checking entitlements file..."
            cat App/App.entitlements
          fi
          echo "‚úÖ Capability check complete"

      - name: Build iOS archive (Automatic Signing)
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          ASC_KEY_ID: ${{ secrets.APPLE_ASC_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APPLE_ASC_KEY_ISSUER_ID }}
        run: |
          cd "$IOS_APP_DIR"
          xcodebuild \
            -workspace App.xcworkspace \
            -scheme "$APP_SCHEME" \
            -configuration Release \
            -sdk iphoneos \
            -archivePath "$ARCHIVE_PATH" \
            -authenticationKeyPath ~/private_keys/AuthKey_${ASC_KEY_ID}.p8 \
            -authenticationKeyID "$ASC_KEY_ID" \
            -authenticationKeyIssuerID "$ASC_ISSUER_ID" \
            -allowProvisioningUpdates \
            -allowProvisioningDeviceRegistration \
            CODE_SIGN_STYLE=Automatic \
            CODE_SIGN_IDENTITY="Apple Development" \
            DEVELOPMENT_TEAM="$APPLE_TEAM_ID" \
            archive

      - name: Export signed IPA (Automatic Signing)
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          cd "$IOS_APP_DIR"
          python3 - <<'PY'
            import os, plistlib

            plist_data = {
                'method': 'development',
                'signingStyle': 'automatic',
                'stripSwiftSymbols': True,
                'compileBitcode': False,
                'teamID': os.environ['APPLE_TEAM_ID']
            }
            with open('exportOptions.plist', 'wb') as fh:
                plistlib.dump(plist_data, fh)
          PY
          xcodebuild -exportArchive \
            -archivePath "$ARCHIVE_PATH" \
            -exportOptionsPlist exportOptions.plist \
            -exportPath "$EXPORT_PATH" \
            -allowProvisioningUpdates

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-app-development
          path: ${{ env.EXPORT_PATH }}/*.ipa
          retention-days: 30

      - name: Build Summary
        run: |
          echo "‚úÖ iOS App build successful" >> $GITHUB_STEP_SUMMARY
          echo "üì¶ Artifact: ios-app-development (.ipa)" >> $GITHUB_STEP_SUMMARY
          echo "üîê Signing: Automatic (App Store Connect API)" >> $GITHUB_STEP_SUMMARY
          echo "üéØ Bundle ID: com.videocall.student" >> $GITHUB_STEP_SUMMARY
