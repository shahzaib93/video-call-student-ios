name: Build iOS App

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-ios:
    name: Build iOS Application
    runs-on: macos-latest

    env:
      PROJECT_DIR: mobile-apps/student-app
      IOS_APP_DIR: mobile-apps/student-app/ios/App
      ARCHIVE_PATH: mobile-apps/student-app/ios/App/build/App.xcarchive
      EXPORT_PATH: mobile-apps/student-app/ios/App/build/export
      APP_SCHEME: App

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          cd "$GITHUB_WORKSPACE/mobile-apps/student-app"
          npm ci

      - name: Build web assets
        run: |
          cd "$GITHUB_WORKSPACE/mobile-apps/student-app"
          npm run build

      - name: Sync Capacitor
        run: |
          cd "$GITHUB_WORKSPACE/mobile-apps/student-app"
          npx cap sync ios

      - name: Install CocoaPods dependencies
        run: |
          cd "${IOS_APP_DIR}"
          pod install

      - name: Install provisioning profile
        id: provisioning
        env:
          APPLE_MOBILEPROVISION: ${{ secrets.APPLE_MOBILEPROVISION }}
        run: |
          PROFILE_DIR="$HOME/Library/MobileDevice/Provisioning Profiles"
          mkdir -p "$PROFILE_DIR"
          echo "$APPLE_MOBILEPROVISION" | base64 --decode > app.mobileprovision
          security cms -D -i app.mobileprovision > app.plist
          PROFILE_UUID=$(/usr/libexec/PlistBuddy -c 'Print UUID' app.plist)
          PROFILE_NAME=$(/usr/libexec/PlistBuddy -c 'Print Name' app.plist)
          mv app.mobileprovision "$PROFILE_DIR/$PROFILE_UUID.mobileprovision"
          echo "uuid=$PROFILE_UUID" >> "$GITHUB_OUTPUT"
          echo "name=$PROFILE_NAME" >> "$GITHUB_OUTPUT"

      - name: Import signing certificate
        env:
          APPLE_P12: ${{ secrets.APPLE_P12 }}
          APPLE_P12_PASSWORD: ${{ secrets.APPLE_P12_PASSWORD }}
        run: |
          KEYCHAIN_PASSWORD=ios-build
          echo "$APPLE_P12" | base64 --decode > signing.p12
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security import signing.p12 -k build.keychain -P "$APPLE_P12_PASSWORD" -T /usr/bin/codesign
          security list-keychains -s build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" build.keychain

      - name: Build iOS archive
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          PROFILE_NAME: ${{ steps.provisioning.outputs.name }}
          PROFILE_UUID: ${{ steps.provisioning.outputs.uuid }}
        run: |
          cd "${IOS_APP_DIR}"
          xcodebuild \
            -workspace App.xcworkspace \
            -scheme "$APP_SCHEME" \
            -configuration Release \
            -sdk iphoneos \
            -archivePath "$ARCHIVE_PATH" \
            DEVELOPMENT_TEAM="$APPLE_TEAM_ID" \
            PROVISIONING_PROFILE="$PROFILE_UUID" \
            PROVISIONING_PROFILE_SPECIFIER="$PROFILE_NAME" \
            CODE_SIGN_STYLE=Manual \
            archive

      - name: Export signed IPA
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_BUNDLE_ID: ${{ secrets.APPLE_BUNDLE_ID }}
          PROFILE_NAME: ${{ steps.provisioning.outputs.name }}
        run: |
          cd "${IOS_APP_DIR}"
          python3 - <<'PY'
            import os, plistlib

            plist_data = {
                'method': 'development',
                'signingStyle': 'manual',
                'stripSwiftSymbols': True,
                'compileBitcode': False,
                'teamID': os.environ['APPLE_TEAM_ID'],
                'provisioningProfiles': {
                    os.environ['APPLE_BUNDLE_ID']: os.environ['PROFILE_NAME']
                }
            }
            with open('exportOptions.plist', 'wb') as fh:
                plistlib.dump(plist_data, fh)
          PY
          xcodebuild -exportArchive \
            -archivePath "$ARCHIVE_PATH" \
            -exportOptionsPlist exportOptions.plist \
            -exportPath "$EXPORT_PATH"

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-app-development
          path: ${{ env.EXPORT_PATH }}/*.ipa
          retention-days: 30

      - name: Build Summary
        run: |
          echo "âœ… Signed iOS App archive created" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ Artifact: ios-app-development (.ipa)" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ” Signing: manual development cert & profile" >> $GITHUB_STEP_SUMMARY
