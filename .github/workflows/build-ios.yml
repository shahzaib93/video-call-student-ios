name: Build iOS App

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-ios:
    name: Build iOS Application
    runs-on: macos-latest

    env:
      IOS_APP_DIR: ios/App
      ARCHIVE_PATH: ios/App/build/App.xcarchive
      EXPORT_PATH: ios/App/build/export
      APP_SCHEME: App

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build web assets
        run: npm run build

      - name: Verify build output
        run: |
          echo "ðŸ“¦ Checking dist folder contents:"
          ls -la dist/
          echo ""
          echo "ðŸ“„ Checking dist/index.html exists:"
          cat dist/index.html | head -20
          echo ""
          echo "âœ… Build verification complete"

      - name: Remove and recreate iOS platform
        run: |
          echo "ðŸ—‘ï¸ Completely removing iOS platform..."
          rm -rf ios
          echo "âœ… iOS platform removed"

          echo "ðŸ†• Adding fresh iOS platform..."
          npx cap add ios
          echo "âœ… Fresh iOS platform added"
          echo ""
          echo "ðŸ“‹ Verifying capacitor.config.json was copied to iOS:"
          cat ios/App/App/capacitor.config.json
          echo ""
          echo "ðŸ“„ Verifying index.html was copied to iOS:"
          ls -la ios/App/App/public/
          echo ""
          echo "ðŸ“„ Checking if index.html exists and has content:"
          if [ -f "ios/App/App/public/index.html" ]; then
            echo "âœ… index.html EXISTS"
            wc -l ios/App/App/public/index.html
            head -30 ios/App/App/public/index.html
          else
            echo "âŒ ERROR: index.html DOES NOT EXIST!"
            exit 1
          fi
          echo ""
          echo "âœ… Capacitor sync complete"

      - name: Verify iOS project structure
        run: |
          echo "ðŸ“‹ Checking iOS project structure..."
          ls -la ios/App/App/
          echo ""
          echo "ðŸ“„ Checking public folder:"
          ls -la ios/App/App/public/
          echo ""
          echo "ðŸ“„ First 50 lines of index.html:"
          head -50 ios/App/App/public/index.html

      - name: Install CocoaPods dependencies
        run: |
          cd "$IOS_APP_DIR"
          pod install

      - name: Save App Store Connect API key
        env:
          ASC_KEY_ID: ${{ secrets.APPLE_ASC_KEY_ID }}
          ASC_PRIVATE_KEY: ${{ secrets.APPLE_ASC_PRIVATE_KEY }}
        run: |
          mkdir -p ~/private_keys
          printf "%s" "$ASC_PRIVATE_KEY" > ~/private_keys/AuthKey_${ASC_KEY_ID}.p8
          chmod 600 ~/private_keys/AuthKey_${ASC_KEY_ID}.p8

      - name: Import signing certificate
        env:
          APPLE_P12: ${{ secrets.APPLE_P12_NEW }}
          APPLE_P12_PASSWORD: ${{ secrets.APPLE_P12_PASSWORD_NEW }}
        run: |
          KEYCHAIN_PASSWORD=ios-build
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain-db"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          echo "$APPLE_P12" | base64 --decode > signing.p12
          security import signing.p12 -k "$KEYCHAIN_PATH" -P "$APPLE_P12_PASSWORD" -T /usr/bin/codesign
          rm signing.p12

          security list-keychains -d user -s "$KEYCHAIN_PATH"
          security default-keychain -s "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

      - name: Build iOS archive (automatic signing)
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          ASC_KEY_ID: ${{ secrets.APPLE_ASC_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APPLE_ASC_KEY_ISSUER_ID }}
        run: |
          cd "$IOS_APP_DIR"
          xcodebuild \
            -workspace App.xcworkspace \
            -scheme "$APP_SCHEME" \
            -configuration Release \
            -sdk iphoneos \
            -archivePath "$ARCHIVE_PATH" \
            -allowProvisioningUpdates \
            -allowProvisioningDeviceRegistration \
            -authenticationKeyPath ~/private_keys/AuthKey_${ASC_KEY_ID}.p8 \
            -authenticationKeyID "$ASC_KEY_ID" \
            -authenticationKeyIssuerID "$ASC_ISSUER_ID" \
            DEVELOPMENT_TEAM="$APPLE_TEAM_ID" \
            MARKETING_VERSION="1.0.0" \
            CURRENT_PROJECT_VERSION="1" \
            archive

      - name: Export signed IPA
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          ASC_KEY_ID: ${{ secrets.APPLE_ASC_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APPLE_ASC_KEY_ISSUER_ID }}
        run: |
          cd "$IOS_APP_DIR"
          python3 - <<'PY'
          import os, plistlib

          data = {
              'method': 'ad-hoc',
              'signingStyle': 'automatic',
              'stripSwiftSymbols': True,
              'compileBitcode': False,
              'teamID': os.environ['APPLE_TEAM_ID'],
          }

          with open('exportOptions.plist', 'wb') as fh:
              plistlib.dump(data, fh)
          PY

          echo "ðŸ“‹ Export options created:"
          cat exportOptions.plist
          echo "ðŸš€ Starting export with API authentication..."
          xcodebuild \
            -exportArchive \
            -archivePath "$ARCHIVE_PATH" \
            -exportOptionsPlist exportOptions.plist \
            -exportPath "$EXPORT_PATH" \
            -allowProvisioningUpdates \
            -authenticationKeyPath ~/private_keys/AuthKey_${ASC_KEY_ID}.p8 \
            -authenticationKeyID "$ASC_KEY_ID" \
            -authenticationKeyIssuerID "$ASC_ISSUER_ID" || {
              echo "âŒ Export failed, checking what was created:"
              ls -la "$EXPORT_PATH" || echo "Export path doesn't exist"
              exit 1
            }

          echo "âœ… Export completed, checking output:"
          ls -la "$EXPORT_PATH"
          find "$EXPORT_PATH" -name "*.ipa" -o -name "*.app"

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-app-development
          path: ios/App/ios/App/build/export/*.ipa
          retention-days: 30

      - name: Build Summary
        run: |
          echo "âœ… iOS App build successful" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ Artifact: ios-app-development (.ipa)" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ” Signing: Automatic provisioning" >> $GITHUB_STEP_SUMMARY
